<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Bookings - Flair</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary: #6366f1;
      --primary-soft: #eef2ff;
      --bg: #f8fafc;
      --text: #1e293b;
      --text-muted: #64748b;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text);
      padding-bottom: 90px;
    }

    .header {
      background: white;
      padding: 20px;
      border-bottom: 1px solid #e2e8f0;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 800;
    }

    .tabs {
      display: flex;
      background: white;
      padding: 0 20px;
      border-bottom: 1px solid #e2e8f0;
      margin-bottom: 16px;
    }

    .tab {
      padding: 14px 0;
      margin-right: 30px;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      position: relative;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .tab span.count {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #4b5563;
      font-weight: 700;
    }

    .tab.active {
      color: var(--primary);
    }

    .tab.active span.count {
      background: var(--primary-soft);
      color: var(--primary);
    }

    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--primary);
    }

    .container {
      padding: 0 20px 20px;
    }

    .tab-panel {
      display: none;
      animation: fadeIn 0.2s ease-out;
    }

    .tab-panel.active {
      display: block;
    }

    .section-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 8px;
      font-weight: 700;
    }

    .booking-card {
      background: white;
      border-radius: 20px;
      padding: 16px 16px 0;
      margin-bottom: 12px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.04);
    }

    .booking-main {
      display: flex;
      gap: 14px;
    }

    .date-box {
      width: 60px;
      height: 60px;
      background: #f1f5f9;
      border-radius: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .date-box .month {
      font-size: 0.7rem;
      text-transform: uppercase;
      font-weight: 800;
      color: var(--primary);
    }

    .date-box .day {
      font-size: 1.2rem;
      font-weight: 800;
    }

    .booking-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .booking-name {
      font-weight: 800;
      font-size: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .booking-name small {
      font-size: 0.7rem;
      color: var(--text-muted);
      font-weight: 600;
    }

    .booking-service {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .booking-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 0.78rem;
      font-weight: 600;
    }

    .meta-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .meta-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .status-upcoming {
      background: #ecfdf3;
      color: #15803d;
    }

    .status-completed {
      background: #eff6ff;
      color: #1d4ed8;
    }

    .status-cancelled {
      background: #fef2f2;
      color: #b91c1c;
    }

    .time-pill {
      padding: 3px 8px;
      border-radius: 999px;
      background: #f1f5f9;
      font-size: 0.72rem;
      color: #4b5563;
    }

    .action-link {
      font-size: 0.72rem;
      color: var(--primary);
      cursor: pointer;
    }

    .amount-chip {
      padding: 3px 8px;
      border-radius: 999px;
      background: #f1f5f9;
      font-size: 0.72rem;
      color: #111827;
      font-weight: 600;
    }

    /* Details section */
    .booking-details {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed #e2e8f0;
      font-size: 0.8rem;
      color: var(--text-muted);
      display: none;
    }

    .booking-details-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      gap: 8px;
    }

    .booking-details-label {
      font-weight: 600;
      color: #6b7280;
    }

    .booking-details-value {
      text-align: right;
      color: #111827;
    }

    .booking-details.visible {
      display: block;
    }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      display: flex;
      justify-content: space-around;
      padding: 12px 10px 25px;
      border-top: 1px solid #e2e8f0;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      color: #94a3b8;
      text-decoration: none;
      font-size: 0.7rem;
      font-weight: 700;
    }

    .nav-item.active {
      color: var(--primary);
    }

    .nav-item i {
      font-size: 1.4rem;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(4px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>

  <div class="header">
    <h1>My Bookings</h1>
  </div>

  <div class="tabs" id="bookingTabs">
    <div class="tab active" data-target="upcomingPanel">
      <span>Upcoming</span>
      <span class="count" id="countUpcoming">0</span>
    </div>
    <div class="tab" data-target="completedPanel">
      <span>Completed</span>
      <span class="count" id="countCompleted">0</span>
    </div>
    <div class="tab" data-target="cancelledPanel">
      <span>Cancelled</span>
      <span class="count" id="countCancelled">0</span>
    </div>
  </div>

  <div class="container">
    <div class="tab-panel active" id="upcomingPanel">
      <div class="section-label">Next visits</div>
      <div id="upcomingList"></div>
    </div>

    <div class="tab-panel" id="completedPanel">
      <div class="section-label">Last visits</div>
      <div id="completedList"></div>
    </div>

    <div class="tab-panel" id="cancelledPanel">
      <div class="section-label">Recently cancelled</div>
      <div id="cancelledList"></div>
    </div>
  </div>

  <nav class="bottom-nav">
    <a href="customer-home.html" class="nav-item">
      <i class="fas fa-house"></i>
      <span>Home</span>
    </a>
    <a href="bookings.html" class="nav-item active">
      <i class="fas fa-calendar-check"></i>
      <span>Bookings</span>
    </a>
    <a href="explore.html" class="nav-item">
      <i class="fas fa-compass"></i>
      <span>Explore</span>
    </a>
    <a href="customer-profile.html" class="nav-item">
      <i class="fas fa-user"></i>
      <span>Profile</span>
    </a>
  </nav>

  <script type="module" src="firebase-init.js"></script>
  <script type="module">
    import {
      collection,
      query,
      where,
      getDocs,
      Timestamp,
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const { auth, db } = window.flairFirebase || {};

    const tabs = document.querySelectorAll('#bookingTabs .tab');
    const panels = document.querySelectorAll('.tab-panel');

    const upcomingListEl = document.getElementById("upcomingList");
    const completedListEl = document.getElementById("completedList");
    const cancelledListEl = document.getElementById("cancelledList");

    const countUpcomingEl = document.getElementById("countUpcoming");
    const countCompletedEl = document.getElementById("countCompleted");
    const countCancelledEl = document.getElementById("countCancelled");

    // Tab switcher
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        const targetId = tab.getAttribute('data-target');
        panels.forEach(panel => {
          panel.classList.toggle('active', panel.id === targetId);
        });
      });
    });

    function formatDateParts(date) {
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const weekdays = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
      return {
        month: months[date.getMonth()],
        day: date.getDate(),
        weekday: weekdays[date.getDay()],
      };
    }

    function formatTime(date) {
      let hours = date.getHours();
      const minutes = date.getMinutes();
      const ampm = hours >= 12 ? "PM" : "AM";
      hours = hours % 12;
      if (hours === 0) hours = 12;
      const mm = minutes.toString().padStart(2, "0");
      return `${hours.toString().padStart(2,"0")}:${mm} ${ampm}`;
    }

    function formatMoney(value) {
      return "₹" + Math.round(value || 0).toLocaleString("en-IN");
    }

    function createBookingCard(booking) {
      const start = booking.startTime instanceof Date
        ? booking.startTime
        : booking.startTime.toDate ? booking.startTime.toDate() : new Date(booking.startTime);

      const { month, day, weekday } = formatDateParts(start);
      const timeLabel = `${weekday} · ${formatTime(start)}`;

      const card = document.createElement("div");
      card.className = "booking-card";

      const main = document.createElement("div");
      main.className = "booking-main";

      const dateBox = document.createElement("div");
      dateBox.className = "date-box";
      dateBox.innerHTML = `
        <span class="month">${month}</span>
        <span class="day">${day}</span>
      `;

      const info = document.createElement("div");
      info.className = "booking-info";

      const nameRow = document.createElement("div");
      nameRow.className = "booking-name";
      const salonSpan = document.createElement("span");
      salonSpan.textContent = booking.salonName || "Salon";
      const distanceSmall = document.createElement("small");
      distanceSmall.textContent = booking.salonArea || "";
      nameRow.appendChild(salonSpan);
      nameRow.appendChild(distanceSmall);

      const serviceRow = document.createElement("div");
      serviceRow.className = "booking-service";
      serviceRow.textContent = booking.serviceName || "Service";

      const metaRow = document.createElement("div");
      metaRow.className = "booking-meta";

      const metaLeft = document.createElement("div");
      metaLeft.className = "meta-left";

      const statusBadge = document.createElement("span");
      statusBadge.className = "status-badge";
      if (booking.status === "upcoming") {
        statusBadge.classList.add("status-upcoming");
        statusBadge.innerHTML = `<i class="fas fa-circle"></i> Confirmed`;
      } else if (booking.status === "completed") {
        statusBadge.classList.add("status-completed");
        statusBadge.innerHTML = `<i class="fas fa-check-circle"></i> Completed`;
      } else {
        statusBadge.classList.add("status-cancelled");
        statusBadge.innerHTML = `<i class="fas fa-times-circle"></i> Cancelled`;
      }

      const timePill = document.createElement("span");
      timePill.className = "time-pill";
      timePill.textContent = timeLabel;

      metaLeft.appendChild(statusBadge);
      metaLeft.appendChild(timePill);

      const metaRight = document.createElement("div");
      metaRight.className = "meta-right";

      const amountChip = document.createElement("span");
      amountChip.className = "amount-chip";
      amountChip.textContent = formatMoney(booking.finalChargeToCustomer || booking.basePrice);

      const viewLink = document.createElement("span");
      viewLink.className = "action-link";
      viewLink.textContent = "View details";

      metaRight.appendChild(amountChip);
      metaRight.appendChild(viewLink);

      metaRow.appendChild(metaLeft);
      metaRow.appendChild(metaRight);

      info.appendChild(nameRow);
      info.appendChild(serviceRow);
      info.appendChild(metaRow);

      main.appendChild(dateBox);
      main.appendChild(info);

      const details = document.createElement("div");
      details.className = "booking-details";

      details.innerHTML = `
        <div class="booking-details-row">
          <span class="booking-details-label">Professional</span>
          <span class="booking-details-value">${booking.staffName || "Any professional"}</span>
        </div>
        <div class="booking-details-row">
          <span class="booking-details-label">Service</span>
          <span class="booking-details-value">${booking.serviceName || "Service"}</span>
        </div>
        <div class="booking-details-row">
          <span class="booking-details-label">Salon</span>
          <span class="booking-details-value">${booking.salonName || "Salon"}</span>
        </div>
        <div class="booking-details-row">
          <span class="booking-details-label">Date & time</span>
          <span class="booking-details-value">${timeLabel}</span>
        </div>
        <div class="booking-details-row">
          <span class="booking-details-label">Duration</span>
          <span class="booking-details-value">${booking.serviceDurationMinutes || 0} min</span>
        </div>
        <div class="booking-details-row">
          <span class="booking-details-label">Amount paid</span>
          <span class="booking-details-value">${formatMoney(booking.finalChargeToCustomer || booking.basePrice)}</span>
        </div>
        ${booking.promoCode ? `
        <div class="booking-details-row">
          <span class="booking-details-label">Promo</span>
          <span class="booking-details-value">${booking.promoCode} (–${formatMoney(booking.promoDiscountAmount || 0)})</span>
        </div>` : ""}
      `;

      viewLink.addEventListener("click", () => {
        const currentlyVisible = details.classList.contains("visible");
        document.querySelectorAll(".booking-details.visible").forEach(el => el.classList.remove("visible"));
        if (!currentlyVisible) {
          details.classList.add("visible");
        }
      });

      card.appendChild(main);
      card.appendChild(details);

      return card;
    }

    async function loadBookingsForUser() {
      if (!auth || !db) {
        console.error("Firebase not initialized");
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        // For now, just show message; later you can redirect to login
        upcomingListEl.innerHTML = "<p style='font-size:0.85rem; color:#6b7280;'>Please log in to see your bookings.</p>";
        completedListEl.innerHTML = "";
        cancelledListEl.innerHTML = "";
        return;
      }

      // v1: assume all appointments across owners are in a top-level collection "allAppointments"
      // filtered by customerUid.
      // If you instead store only under owners/{ownerId}, you will loop owners.
      const allApptsCol = collection(db, "allAppointments");
      const q = query(allApptsCol, where("customerUid", "==", user.uid));
      const snap = await getDocs(q);

      const now = new Date();
      const upcoming = [];
      const completed = [];
      const cancelled = [];

      snap.forEach(docSnap => {
        const data = docSnap.data() || {};
        if (!data.startTime) return;

        const start = data.startTime.toDate ? data.startTime.toDate() : new Date(data.startTime);
        data.startTime = start;

        const status = data.status || "upcoming";

        if (status === "cancelled") {
          cancelled.push(data);
        } else if (status === "completed" || start < now) {
          completed.push(data);
        } else {
          upcoming.push(data);
        }
      });

      upcoming.sort((a, b) => a.startTime - b.startTime);
      completed.sort((a, b) => b.startTime - a.startTime);
      cancelled.sort((a, b) => b.startTime - a.startTime);

      upcomingListEl.innerHTML = "";
      completedListEl.innerHTML = "";
      cancelledListEl.innerHTML = "";

      if (upcoming.length === 0) {
        upcomingListEl.innerHTML = "<p style='font-size:0.85rem; color:#6b7280;'>No upcoming bookings yet.</p>";
      } else {
        upcoming.forEach(b => upcomingListEl.appendChild(createBookingCard(b)));
      }

      if (completed.length === 0) {
        completedListEl.innerHTML = "<p style='font-size:0.85rem; color:#6b7280;'>No completed bookings yet.</p>";
      } else {
        completed.forEach(b => completedListEl.appendChild(createBookingCard(b)));
      }

      if (cancelled.length === 0) {
        cancelledListEl.innerHTML = "<p style='font-size:0.85rem; color:#6b7280;'>No cancelled bookings.</p>";
      } else {
        cancelled.forEach(b => cancelledListEl.appendChild(createBookingCard(b)));
      }

      countUpcomingEl.textContent = upcoming.length;
      countCompletedEl.textContent = completed.length;
      countCancelledEl.textContent = cancelled.length;
    }

    // Wait for Firebase auth to be ready
    const unsubscribe = auth.onAuthStateChanged(async (user) => {
      await loadBookingsForUser();
      unsubscribe();
    });
  </script>
</body>
</html>
