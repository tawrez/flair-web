<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flair – Payment options</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <style>
    :root {
      /* Light Flair owner theme */
      --bg: radial-gradient(circle at top left, #fdf2ff, #f9f5ff 45%, #f4f4ff 100%);
      --shell-bg: #ffffff;
      --card-bg: #ffffff;
      --border: #e2d4f5;

      --accent: #b47eb3;
      --accent-blue: #6366f1;
      --accent-purple: #ec4899;

      --text-main: #1f2933;
      --text-muted: #6b7280;

      --radius-lg: 22px;
      --radius-pill: 999px;
      --shadow-shell: 0 18px 50px rgba(148, 163, 184, 0.35);
      --shadow-card: 0 10px 30px rgba(148, 163, 184, 0.25);
      --transition-fast: 0.18s ease-out;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
    }

    body {
      min-height: 100vh;
      background: var(--bg);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      padding: 14px;
    }

    .shell {
      width: 100%;
      max-width: 900px;
      background: var(--shell-bg);
      border-radius: 26px;
      border: 1px solid #f3e8ff;
      box-shadow: var(--shadow-shell);
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    .shell::before {
      content: "";
      position: absolute;
      inset: -20% -20% auto auto;
      background: radial-gradient(circle at top right, rgba(180, 126, 179, 0.18), transparent 70%);
      pointer-events: none;
      opacity: 1;
    }

    header {
      padding: 14px 20px 10px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      background: linear-gradient(90deg, #ffffffcc, #fdf2ffdd);
      backdrop-filter: blur(14px);
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .brand-logo-text {
      font-size: 1.05rem;
      font-weight: 800;
      background: linear-gradient(120deg, #b47eb3, #ec4899, #6366f1);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: 0.05em;
    }
    .brand-sub {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #9f7aea;
    }

    .back-btn {
      font-size: 0.8rem;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 7px 14px;
      border-radius: var(--radius-pill);
      border: 1px solid #f9a8d4;
      background: linear-gradient(135deg, #fce7f3, #f5e3ff);
      color: #4b164c;
      box-shadow: 0 10px 26px rgba(244, 114, 182, 0.45);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    .back-btn i {
      font-size: 0.85rem;
    }
    .back-btn:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    main {
      padding: 18px 20px 18px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: radial-gradient(circle at top left, #fdf2ff, #ffffff 45%, #f9fafb 100%);
    }

    .title-block h1 {
      font-size: 1.25rem;
      margin-bottom: 4px;
    }
    .title-block p {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .tabs {
      margin-top: 8px;
      display: flex;
      gap: 10px;
      border-radius: var(--radius-pill);
      padding: 4px;
      background: #f3e8ff;
      border: 1px solid #e5e7eb;
    }

    .tab {
      flex: 1;
      border-radius: var(--radius-pill);
      padding: 8px 14px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: var(--text-muted);
      cursor: pointer;
      border: none;
      background: transparent;
      transition: all var(--transition-fast);
    }
    .tab i {
      font-size: 1rem;
    }
    .tab.active {
      color: #4b164c;
      background: #ffffff;
      box-shadow: 0 8px 20px rgba(148, 163, 184, 0.35);
    }

    .card {
      margin-top: 14px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      box-shadow: var(--shadow-card);
      padding: 14px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .card-header h2 {
      font-size: 0.95rem;
    }
    .card-header span {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .badge {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: var(--radius-pill);
      border: 1px solid #f9a8d4;
      color: #4b164c;
      background: #fdf2ff;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }
    label {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    input, textarea {
      width: 100%;
      padding: 9px 11px;
      border-radius: 11px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      color: var(--text-main);
      font-size: 0.9rem;
      outline: none;
      transition: all var(--transition-fast);
    }
    input:focus, textarea:focus {
      border-color: #c4b5fd;
      box-shadow: 0 0 0 1px #c4b5fd;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }

    .hint {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .qr-upload-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 6px;
      flex-wrap: wrap;
    }
    .qr-preview {
      width: 72px;
      height: 72px;
      border-radius: 16px;
      border: 1px dashed #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 0.75rem;
      overflow: hidden;
      background: #f9fafb;
    }
    .qr-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .upload-btn {
      padding: 7px 12px;
      border-radius: var(--radius-pill);
      border: 1px solid #c4b5fd;
      background: #eef2ff;
      color: #4b164c;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    .upload-btn:hover {
      filter: brightness(1.03);
    }
    #upiQrInput {
      display: none;
    }

    /* Card visual */
    .card-visual {
      position: relative;
      border-radius: 20px;
      padding: 14px;
      background: radial-gradient(circle at top left, #6366f1, #a855f7 55%, #f5f3ff 100%);
      overflow: hidden;
      color: #f9fafb;
    }
    .card-visual::before {
      content: "";
      position: absolute;
      inset: -30% 10% auto auto;
      background: radial-gradient(circle at top right, rgba(251, 191, 36, 0.6), transparent 70%);
      opacity: 0.7;
    }
    .card-chip {
      width: 34px;
      height: 24px;
      border-radius: 8px;
      background: linear-gradient(135deg, #facc15, #f97316);
      margin-bottom: 12px;
      position: relative;
      z-index: 1;
    }
    .card-brand {
      position: absolute;
      top: 14px;
      right: 14px;
      z-index: 1;
      font-size: 1.1rem;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .card-brand span.dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #facc15;
    }

    .card-fields {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 6px;
    }
    .card-number-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 4px;
      font-size: 0.85rem;
      letter-spacing: 0.12em;
    }
    .card-label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.7rem;
      color: #e5e7eb;
      margin-top: 4px;
    }
    .card-holder-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
    }

    .card-input-row {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .inline-fields {
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 6px;
    }
    .inline-fields input {
      font-size: 0.8rem;
      padding: 7px 10px;
      border-radius: 9px;
      border-color: #e5e7eb;
      background: #f9fafb;
      color: #111827;
    }

    .save-bar {
      margin-top: 14px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 8px 16px;
      border-radius: var(--radius-pill);
      border: 1px solid #e5e7eb;
      background: #ffffff;
      color: #111827;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    .btn.primary {
      border-color: #f9a8d4;
      background: linear-gradient(135deg, #fce7f3, #f5e3ff);
      color: #4b164c;
      box-shadow: 0 8px 22px rgba(244, 114, 182, 0.55);
    }
    .btn.primary:hover {
      filter: brightness(1.03);
    }

    @media (max-width: 900px) {
      .shell {
        height: auto;
        min-height: 100vh;
        border-radius: 0;
        border: none;
      }
      body {
        padding: 0;
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="brand">
        <div class="brand-logo-text">Flair</div>
        <div class="brand-sub">Payment options</div>
      </div>
      <a href="owner-dashboard.html" id="backToDashboard" class="back-btn">
        <i class="fas fa-arrow-left"></i>
        Back to dashboard
      </a>
    </header>

    <main>
      <div class="title-block">
        <h1>Choose how you want to get paid</h1>
        <p>Set up UPI or card payouts so customers can pay you smoothly.</p>
      </div>

      <div class="tabs">
        <button class="tab active" id="tabUpi">
          <i class="fas fa-qrcode"></i>
          <span>UPI / QR</span>
        </button>
        <button class="tab" id="tabCard">
          <i class="fas fa-credit-card"></i>
          <span>Card payouts</span>
        </button>
      </div>

      <!-- UPI section -->
      <section class="card" id="upiSection">
        <div class="card-header">
          <div>
            <h2>UPI payment details</h2>
            <span>Customers can scan or pay to your UPI ID</span>
          </div>
          <span class="badge">Recommended</span>
        </div>

        <div class="field-group">
          <label>UPI ID (VPA)</label>
          <input type="text" id="upiId" placeholder="yourname@bank" />
          <span class="hint">Example: salonname@upi or mobile-number@bank</span>
        </div>

        <div class="field-group">
          <label>UPI QR code (optional)</label>
          <div class="qr-upload-row">
            <div class="qr-preview" id="upiQrPreview">
              <span>No QR uploaded</span>
            </div>
            <div>
              <label class="upload-btn" for="upiQrInput">
                <i class="fas fa-upload"></i>
                Upload scanner
              </label>
              <input type="file" id="upiQrInput" accept="image/*" />
              <div class="hint">We’ll store this only to show the QR to customers.</div>
            </div>
          </div>
        </div>

        <div class="field-group">
          <label>Notes for customers (optional)</label>
          <textarea id="upiNotes" placeholder="Any note you want to show near the QR (e.g. 'Please avoid cash payments on weekends')"></textarea>
        </div>

        <div class="save-bar">
          <button class="btn primary" id="saveUpiBtn">
            <i class="fas fa-floppy-disk"></i>
            Save UPI details
          </button>
        </div>
      </section>

      <!-- Card section -->
      <section class="card" id="cardSection" style="display:none;">
        <div class="card-header">
          <div>
            <h2>Card payout reference</h2>
            <span>Save how you receive settlements</span>
          </div>
        </div>

        <div class="card-visual">
          <div class="card-chip"></div>
          <div class="card-brand">
            <span class="dot"></span>
            <span id="cardBrandLabel">MasterCard</span>
          </div>

          <div class="card-fields">
            <div class="card-number-row" id="cardNumberMasked">
              <span>••••</span><span>••••</span><span>••••</span><span>1234</span>
            </div>
            <div class="card-label-row">
              <span>CARD HOLDER</span>
              <span>EXP</span>
            </div>
            <div class="card-holder-row">
              <span id="cardHolderPreview">Salon Owner</span>
              <span id="cardExpPreview">MM/YY</span>
            </div>
          </div>

          <div class="card-input-row">
            <label style="font-size:0.8rem; color:#f9fafb;">Card reference (from your gateway)</label>
            <input
              type="text"
              id="cardToken"
              placeholder="Example: token or ID from Razorpay/Stripe"
            />
            <div class="inline-fields">
              <input
                type="text"
                id="cardLast4"
                maxlength="4"
                placeholder="Last 4 digits"
              />
              <input
                type="text"
                id="cardBrand"
                placeholder="Brand (Visa, Mastercard...)"
              />
            </div>
            <input
              type="text"
              id="cardHolder"
              placeholder="Card holder name"
              style="margin-top:4px;"
            />
            <input
              type="text"
              id="cardExp"
              placeholder="Expiry (MM/YY)"
            />
            <div class="hint" style="color:#f9fafb; opacity:0.85;">
              Do not paste full card numbers or CVV here. Your payment gateway
              should give you a token / reference ID only.
            </div>
          </div>

          <div class="save-bar" style="margin-top:10px;">
            <button class="btn primary" id="saveCardBtn">
              <i class="fas fa-floppy-disk"></i>
              Save card reference
            </button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Firebase init -->
  <script type="module" src="firebase-init.js"></script>

  <script type="module">
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

    const { auth, db, firestoreFns } = window.flairFirebase || {};
    const { doc, getDoc, setDoc, serverTimestamp } = firestoreFns || {};

    function ensureFirebase() {
      if (!auth || !db || !doc || !getDoc || !setDoc || !serverTimestamp) {
        alert("Firebase not initialized on this page. Please check firebase-init.js.");
        throw new Error("Firebase not initialized in payment-option-owner page");
      }
    }

    // Tabs + sections
    const tabUpi = document.getElementById("tabUpi");
    const tabCard = document.getElementById("tabCard");
    const upiSection = document.getElementById("upiSection");
    const cardSection = document.getElementById("cardSection");

    function setActiveTab(tab) {
      if (tab === "upi") {
        tabUpi.classList.add("active");
        tabCard.classList.remove("active");
        upiSection.style.display = "flex";
        cardSection.style.display = "none";
      } else {
        tabCard.classList.add("active");
        tabUpi.classList.remove("active");
        upiSection.style.display = "none";
        cardSection.style.display = "block";
      }
    }
    tabUpi.addEventListener("click", () => setActiveTab("upi"));
    tabCard.addEventListener("click", () => setActiveTab("card"));

    // Keep salonId in back link
    const params = new URLSearchParams(window.location.search);
    const salonIdFromUrl = params.get("salonId") || "";
    const backLink = document.getElementById("backToDashboard");
    if (salonIdFromUrl) {
      backLink.href = `owner-dashboard.html?salonId=${encodeURIComponent(
        salonIdFromUrl
      )}`;
    }

    // UPI QR preview (local only)
    const upiQrInput = document.getElementById("upiQrInput");
    const upiQrPreview = document.getElementById("upiQrPreview");
    let upiQrTempDataUrl = null;

    upiQrInput.addEventListener("change", () => {
      const file = upiQrInput.files && upiQrInput.files[0];
      if (!file) {
        upiQrTempDataUrl = null;
        upiQrPreview.innerHTML = "<span>No QR uploaded</span>";
        return;
      }
      const reader = new FileReader();
      reader.onload = (e) => {
        upiQrTempDataUrl = e.target.result;
        upiQrPreview.innerHTML = `<img src="${upiQrTempDataUrl}" alt="UPI QR">`;
      };
      reader.readAsDataURL(file);
    });

    // Card live preview
    const cardLast4Input = document.getElementById("cardLast4");
    const cardHolderInput = document.getElementById("cardHolder");
    const cardExpInput = document.getElementById("cardExp");
    const cardHolderPreview = document.getElementById("cardHolderPreview");
    const cardExpPreview = document.getElementById("cardExpPreview");
    const cardNumberMasked = document.getElementById("cardNumberMasked");
    const cardBrandInput = document.getElementById("cardBrand");
    const cardBrandLabel = document.getElementById("cardBrandLabel");

    function updateCardPreview() {
      const last4 = (cardLast4Input.value || "").replace(/\D/g, "").slice(-4);
      cardNumberMasked.innerHTML = `
        <span>••••</span><span>••••</span><span>••••</span><span>${last4 || "1234"}</span>
      `;
      const holder = cardHolderInput.value.trim() || "Salon Owner";
      cardHolderPreview.textContent = holder;
      cardExpPreview.textContent = cardExpInput.value.trim() || "MM/YY";
      cardBrandLabel.textContent = cardBrandInput.value.trim() || "MasterCard";
    }

    cardLast4Input.addEventListener("input", updateCardPreview);
    cardHolderInput.addEventListener("input", updateCardPreview);
    cardExpInput.addEventListener("input", updateCardPreview);
    cardBrandInput.addEventListener("input", updateCardPreview);

    // Save buttons
    const saveUpiBtn = document.getElementById("saveUpiBtn");
    const saveCardBtn = document.getElementById("saveCardBtn");

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }

      try {
        ensureFirebase();

        // Load existing paymentMethods if any
        const payRef = doc(db, "paymentMethods", user.uid);
        const snap = await getDoc(payRef);
        if (snap.exists()) {
          const data = snap.data() || {};
          if (data.upiId) document.getElementById("upiId").value = data.upiId;
          if (data.upiNotes) document.getElementById("upiNotes").value = data.upiNotes;

          if (data.cardLast4) cardLast4Input.value = data.cardLast4;
          if (data.cardBrand) cardBrandInput.value = data.cardBrand;
          if (data.cardHolder) cardHolderInput.value = data.cardHolder;
          if (data.cardExp) cardExpInput.value = data.cardExp;
          if (data.cardToken) document.getElementById("cardToken").value = data.cardToken;

          updateCardPreview();
        }
      } catch (err) {
        console.error("Error preloading payment methods:", err);
      }

      saveUpiBtn.addEventListener("click", async () => {
        try {
          ensureFirebase();
          const upiId = document.getElementById("upiId").value.trim();
          const upiNotes = document.getElementById("upiNotes").value.trim();

          if (!upiId) {
            alert("Please enter your UPI ID.");
            return;
          }

          const payRef = doc(db, "paymentMethods", user.uid);
          await setDoc(
            payRef,
            {
              ownerId: user.uid,
              defaultSalonId: salonIdFromUrl || null,
              upiConfigured: true,
              upiId,
              upiNotes,
              updatedAt: serverTimestamp(),
            },
            { merge: true }
          );
          alert("UPI details saved.");
        } catch (err) {
          console.error("Error saving UPI:", err);
          alert("Could not save UPI details. Please try again.");
        }
      });

      saveCardBtn.addEventListener("click", async () => {
        try {
          ensureFirebase();
          const cardToken = document.getElementById("cardToken").value.trim();
          const cardLast4 = cardLast4Input.value.trim();
          const cardBrand = cardBrandInput.value.trim();
          const cardHolder = cardHolderInput.value.trim();
          const cardExp = cardExpInput.value.trim();

          if (!cardToken) {
            alert("Enter the card reference/token from your payment gateway.");
            return;
          }

          const payRef = doc(db, "paymentMethods", user.uid);
          await setDoc(
            payRef,
            {
              ownerId: user.uid,
              defaultSalonId: salonIdFromUrl || null,
              cardConfigured: true,
              cardToken,
              cardLast4,
              cardBrand,
              cardHolder,
              cardExp,
              updatedAt: serverTimestamp(),
            },
            { merge: true }
          );
          alert("Card reference saved.");
        } catch (err) {
          console.error("Error saving card:", err);
          alert("Could not save card details. Please try again.");
        }
      });
    });
  </script>
</body>
</html>
