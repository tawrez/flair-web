<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout - Flair</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <style>
    :root {
      --primary: #6366f1;
      --bg: #f8fafc;
      --text: #1e293b;
      --text-muted: #64748b;
      --danger: #f97373;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
    }
    body {
      background: var(--bg);
      color: var(--text);
      padding-bottom: 130px;
    }

    .navbar {
      background: white;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #e2e8f0;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .navbar-back-btn {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid #e2e8f0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      background: #f8fafc;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .logo {
      font-weight: 800;
      font-size: 1.2rem;
      background: linear-gradient(120deg, #6366f1, #a855f7);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: 0.05em;
      text-transform: lowercase;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px 16px 24px;
    }

    .page-title {
      font-size: 1.45rem;
      font-weight: 800;
      margin-bottom: 22px;
    }

    .section-title {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 10px;
    }

    .card {
      background: white;
      border-radius: 16px;
      border: 1px solid #e2e8f0;
      overflow: hidden;
      margin-bottom: 16px;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.03);
    }

    .card-body {
      padding: 18px 18px 16px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f1f5f9;
      gap: 12px;
    }
    .summary-row:last-child {
      border-bottom: none;
    }

    .summary-label {
      color: var(--text-muted);
      font-size: 0.86rem;
    }
    .summary-value {
      font-weight: 600;
      font-size: 0.9rem;
      text-align: right;
    }

    .total-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 18px;
      background: #f8fafc;
      border-top: 2px solid #e2e8f0;
    }

    .total-label {
      font-weight: 700;
      font-size: 0.98rem;
    }
    .total-amount {
      font-weight: 800;
      font-size: 1.2rem;
      color: var(--primary);
    }

    .note-text {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 6px;
    }

    /* Promo */
    .promo-row {
      display: flex;
      gap: 8px;
      padding: 6px 0;
      align-items: center;
    }

    .promo-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      font-size: 0.86rem;
      color: var(--text);
      background: white;
    }
    .promo-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.2);
    }

    .btn-apply {
      background: var(--primary);
      color: white;
      padding: 10px 16px;
      border-radius: 12px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      font-size: 0.86rem;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    /* Payment options */
    .payment-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 18px;
      border-bottom: 1px solid #f1f5f9;
      cursor: pointer;
      transition: all 0.16s ease-out;
    }
    .payment-option:last-child {
      border-bottom: none;
    }
    .payment-option.active {
      background: rgba(99, 102, 241, 0.05);
    }

    .payment-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: #f1f5f9;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }

    .payment-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .payment-name {
      font-weight: 600;
      font-size: 0.94rem;
    }
    .payment-desc {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .radio-check {
      margin-left: auto;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
      color: white;
      transition: all 0.16s ease-out;
    }

    .radio-check.checked {
      border-color: var(--primary);
      background: var(--primary);
    }

    /* Footer pay bar */
    .footer-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 12px 20px 18px;
      border-top: 1px solid #e2e8f0;
      z-index: 100;
    }

    .btn-pay {
      width: 100%;
      background: linear-gradient(135deg, #6366f1, #a855f7);
      color: white;
      padding: 14px;
      border-radius: 14px;
      font-weight: 700;
      font-size: 0.98rem;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.16s ease-out;
      box-shadow: 0 10px 26px rgba(99, 102, 241, 0.3);
    }
    .btn-pay:hover:not(:disabled) {
      opacity: 0.96;
      transform: translateY(-1px);
    }
    .btn-pay:disabled {
      opacity: 0.7;
      cursor: default;
      box-shadow: none;
    }

    /* Card form bottom sheet */
    .card-form-sheet {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      border-top-left-radius: 18px;
      border-top-right-radius: 18px;
      box-shadow: 0 -10px 34px rgba(15, 23, 42, 0.35);
      padding: 14px 18px 18px;
      z-index: 150;
      transform: translateY(100%);
      transition: transform 0.22s ease-out;
      max-width: 600px;
      margin: 0 auto;
    }
    .card-form-sheet.visible {
      transform: translateY(0%);
    }

    .card-form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .card-form-title {
      font-size: 0.96rem;
      font-weight: 700;
    }
    .card-form-close {
      border: none;
      background: transparent;
      font-size: 1rem;
      cursor: pointer;
      color: var(--text-muted);
    }

    .card-form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 6px;
    }

    .card-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.8rem;
    }

    .card-label {
      color: var(--text-muted);
    }

    .card-input {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      font-size: 0.86rem;
      outline: none;
      background: #f9fafb;
      color: var(--text);
      transition: all 0.16s ease-out;
    }
    .card-input::placeholder {
      color: #9ca3af;
    }
    .card-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.3);
      background: white;
    }

    .card-form-row-inline {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .card-form-hint {
      font-size: 0.72rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .card-error {
      font-size: 0.76rem;
      color: var(--danger);
      margin-top: 4px;
      min-height: 16px;
    }

    /* UPI app overlay */
    .overlay-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 160;
      align-items: center;
      justify-content: center;
    }

    .upi-sheet {
      background: white;
      border-radius: 18px;
      padding: 18px 18px 16px;
      max-width: 320px;
      margin: 0 16px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.45);
    }

    .upi-title {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .upi-sub {
      font-size: 0.82rem;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .upi-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px;
    }

    .upi-app {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      cursor: pointer;
      font-size: 0.86rem;
      transition: all 0.16s ease-out;
    }
    .upi-app:hover {
      border-color: var(--primary);
      background: #f5f3ff;
    }

    .upi-app-icon {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      background: #f1f5f9;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
    }

    .upi-close {
      margin-top: 4px;
      width: 100%;
      padding: 9px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      font-size: 0.86rem;
      cursor: pointer;
      color: var(--text-muted);
    }

    /* Confirmation overlay */
    .confirmation-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }

    .confirmation-card {
      background: white;
      border-radius: 24px;
      padding: 30px 24px 24px;
      text-align: center;
      max-width: 320px;
      margin: 20px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.45);
    }

    .check-icon {
      width: 70px;
      height: 70px;
      background: linear-gradient(135deg, #10b981, #34d399);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 18px;
      font-size: 2rem;
      color: white;
    }

    .confirmation-title {
      font-size: 1.35rem;
      font-weight: 800;
      margin-bottom: 6px;
    }

    .confirmation-sub {
      color: var(--text-muted);
      margin-bottom: 18px;
      font-size: 0.9rem;
    }

    .btn-done {
      width: 100%;
      background: var(--primary);
      color: white;
      padding: 12px;
      border-radius: 12px;
      font-weight: 700;
      border: none;
      cursor: pointer;
      font-size: 0.96rem;
    }

    @media (max-width: 480px) {
      .navbar {
        padding-inline: 14px;
      }
      .container {
        padding-inline: 14px;
      }
      .card-form-sheet {
        padding-inline: 14px;
      }
      .footer-bar {
        padding-inline: 16px;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <button class="navbar-back-btn" id="backBtn">
      <i class="fas fa-arrow-left"></i>
    </button>
    <div class="logo">flair</div>
    <div style="width: 28px;"></div>
  </nav>

  <div class="container">
    <h2 class="page-title">Order summary</h2>

    <p class="section-title">Booking details</p>
    <div class="card">
      <div class="card-body">
        <div class="summary-row">
          <span class="summary-label">Service</span>
          <span class="summary-value" id="serviceName">–</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Professional</span>
          <span class="summary-value" id="staffName">Any professional</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Date &amp; time</span>
          <span class="summary-value" id="dateTimeText">–</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Duration</span>
          <span class="summary-value" id="durationText">–</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Salon</span>
          <span class="summary-value" id="salonName">–</span>
        </div>
      </div>
      <div class="total-row">
        <span class="total-label">Total</span>
        <span class="total-amount" id="totalAmount">₹0</span>
      </div>
    </div>

    <div class="note-text">
      Platform fee helps us run Flair, provide secure bookings and timely reminders.
    </div>

    <p class="section-title" style="margin-top:18px;">Price breakdown</p>
    <div class="card">
      <div class="card-body">
        <div class="summary-row">
          <span class="summary-label">Service price</span>
          <span class="summary-value" id="servicePriceRow">₹0</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Promo discount</span>
          <span class="summary-value" id="promoDiscountRow">–₹0</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Effective service price</span>
          <span class="summary-value" id="effectiveServiceRow">₹0</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Platform fee (12%)</span>
          <span class="summary-value" id="platformFeeRow">₹0</span>
        </div>
      </div>
    </div>

    <p class="section-title">Promo code</p>
    <div class="card">
      <div class="card-body">
        <div class="promo-row">
          <input type="text" class="promo-input" id="promoInput" placeholder="Enter promo code" />
          <button class="btn-apply" type="button" id="applyPromoBtn">
            Apply
          </button>
        </div>
        <div id="promoMessage" style="font-size:0.78rem; color:var(--text-muted); min-height:16px;"></div>
      </div>
    </div>

    <p class="section-title">Payment method</p>
    <div class="card">
      <div class="payment-option active" data-method="upi">
        <div class="payment-icon" style="color:#6366f1;">
          <i class="fas fa-mobile-alt"></i>
        </div>
        <div class="payment-text">
          <div class="payment-name">UPI</div>
          <div class="payment-desc">GPay, PhonePe, Paytm and more</div>
        </div>
        <div class="radio-check checked">
          <i class="fas fa-check"></i>
        </div>
      </div>

      <div class="payment-option" data-method="card">
        <div class="payment-icon" style="color:#f59e0b;">
          <i class="fas fa-credit-card"></i>
        </div>
        <div class="payment-text">
          <div class="payment-name">Card</div>
          <div class="payment-desc">Credit / Debit card</div>
        </div>
        <div class="radio-check"></div>
      </div>
    </div>
  </div>

  <div class="footer-bar">
    <button class="btn-pay" id="payBtn" disabled>
      <i class="fas fa-lock"></i>
      <span id="payBtnText">Pay securely</span>
    </button>
  </div>

  <!-- Card payment bottom sheet -->
  <div class="card-form-sheet" id="cardFormSheet">
    <div class="card-form-header">
      <span class="card-form-title">Pay with card</span>
      <button class="card-form-close" type="button" id="cardFormCloseBtn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="card-form-grid">
      <div class="card-field">
        <label class="card-label" for="cardNumberInput">Card number</label>
        <input
          type="text"
          id="cardNumberInput"
          class="card-input"
          placeholder="XXXX XXXX XXXX 1234"
          maxlength="19"
        />
      </div>
      <div class="card-form-row-inline">
        <div class="card-field">
          <label class="card-label" for="cardExpiryInput">Expiry (MM/YY)</label>
          <input
            type="text"
            id="cardExpiryInput"
            class="card-input"
            placeholder="MM/YY"
            maxlength="5"
          />
        </div>
        <div class="card-field">
          <label class="card-label" for="cardCvvInput">CVV</label>
          <input
            type="password"
            id="cardCvvInput"
            class="card-input"
            placeholder="123"
            maxlength="4"
          />
        </div>
      </div>
      <div class="card-field">
        <label class="card-label" for="cardNameInput">Name on card</label>
        <input
          type="text"
          id="cardNameInput"
          class="card-input"
          placeholder="As printed on card"
        />
      </div>
      <div class="card-form-hint">
        This is a demo flow. Real card processing will be added via a payment gateway.
      </div>
      <div class="card-error" id="cardErrorText"></div>
    </div>
  </div>

  <!-- UPI app picker overlay -->
  <div class="overlay-backdrop" id="upiOverlay">
    <div class="upi-sheet">
      <div class="upi-title">Pay via UPI</div>
      <div class="upi-sub">Choose your preferred UPI app to complete the payment.</div>
      <div class="upi-list">
        <div class="upi-app">
          <div class="upi-app-icon" style="color:#2563eb;">
            <i class="fab fa-google"></i>
          </div>
          <span>GPay (demo)</span>
        </div>
        <div class="upi-app">
          <div class="upi-app-icon" style="color:#7c3aed;">
            <i class="fas fa-phone-alt"></i>
          </div>
          <span>PhonePe (demo)</span>
        </div>
        <div class="upi-app">
          <div class="upi-app-icon" style="color:#22c55e;">
            <i class="fas fa-wallet"></i>
          </div>
          <span>Paytm (demo)</span>
        </div>
      </div>
      <button class="upi-close" type="button" id="upiCloseBtn">Cancel</button>
    </div>
  </div>

  <!-- Confirmation overlay -->
  <div class="confirmation-overlay" id="confirmOverlay">
    <div class="confirmation-card">
      <div class="check-icon">
        <i class="fas fa-check"></i>
      </div>
      <div class="confirmation-title">Booking confirmed!</div>
      <div class="confirmation-sub">
        Your appointment has been successfully booked. We’ll send you a reminder before your visit.
      </div>
      <button class="btn-done" id="doneBtn">
        Go to home
      </button>
    </div>
  </div>

  <script type="module" src="firebase-init.js"></script>
  <script type="module">
    import {
      collection,
      doc,
      getDoc,
      addDoc,
      Timestamp,
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const { auth, db } = window.flairFirebase || {};

    const params = new URLSearchParams(window.location.search);
    const salonId = params.get("salonId") || "";
    const serviceId = params.get("serviceId") || "";
    const staffId = params.get("staffId") || "";
    const dateKey = params.get("date") || ""; // YYYY-MM-DD
    const timeIso = params.get("time") || ""; // ISO from slot page

    const backBtn = document.getElementById("backBtn");
    const serviceNameEl = document.getElementById("serviceName");
    const staffNameEl = document.getElementById("staffName");
    const dateTimeTextEl = document.getElementById("dateTimeText");
    const durationTextEl = document.getElementById("durationText");
    const salonNameEl = document.getElementById("salonName");

    const servicePriceRow = document.getElementById("servicePriceRow");
    const promoDiscountRow = document.getElementById("promoDiscountRow");
    const effectiveServiceRow = document.getElementById("effectiveServiceRow");
    const platformFeeRow = document.getElementById("platformFeeRow");
    const totalAmountEl = document.getElementById("totalAmount");
    const payBtn = document.getElementById("payBtn");
    const payBtnText = document.getElementById("payBtnText");

    const promoInput = document.getElementById("promoInput");
    const applyPromoBtn = document.getElementById("applyPromoBtn");
    const promoMessage = document.getElementById("promoMessage");

    const paymentOptions = document.querySelectorAll(".payment-option");
    const upiOverlay = document.getElementById("upiOverlay");
    const upiCloseBtn = document.getElementById("upiCloseBtn");
    const confirmOverlay = document.getElementById("confirmOverlay");
    const doneBtn = document.getElementById("doneBtn");

    const cardFormSheet = document.getElementById("cardFormSheet");
    const cardFormCloseBtn = document.getElementById("cardFormCloseBtn");
    const cardNumberInput = document.getElementById("cardNumberInput");
    const cardExpiryInput = document.getElementById("cardExpiryInput");
    const cardCvvInput = document.getElementById("cardCvvInput");
    const cardNameInput = document.getElementById("cardNameInput");
    const cardErrorText = document.getElementById("cardErrorText");

    const upiApps = document.querySelectorAll(".upi-app");

    const PLATFORM_FEE_PERCENT = 0.12;

    let ownerId = null;
    let basePrice = 0;
    let serviceDurationMinutes = 0;
    let salonName = "";
    let serviceName = "";
    let staffName = "";
    let staffRole = "";

    let selectedStartTime = timeIso ? new Date(timeIso) : null;
    let selectedEndTime = null;

    let appliedPromo = null;
    let currentMethod = "upi";

    backBtn.addEventListener("click", () => {
      if (window.history.length > 1) {
        window.history.back();
      } else {
        window.location.href = "select-slot.html";
      }
    });

    function formatDateTimeLabel(date) {
      if (!date) return "–";
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const weekdays = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
      const weekday = weekdays[date.getDay()];
      const day = date.getDate();
      const month = months[date.getMonth()];

      let hours = date.getHours();
      const minutes = date.getMinutes();
      const ampm = hours >= 12 ? "PM" : "AM";
      hours = hours % 12;
      if (hours === 0) hours = 12;
      const mm = minutes.toString().padStart(2, "0");
      const timePart = `${hours.toString().padStart(2,"0")}:${mm} ${ampm}`;

      return `${weekday}, ${day} ${month} • ${timePart}`;
    }

    function formatMoney(value) {
      return "₹" + Math.round(value).toLocaleString("en-IN");
    }

    function recomputeTotals() {
      const promoDiscount = appliedPromo ? appliedPromo.discountAmount : 0;
      const effectiveServicePrice = Math.max(0, basePrice - promoDiscount);
      const platformFeeAmount = effectiveServicePrice * PLATFORM_FEE_PERCENT;
      const finalChargeToCustomer = effectiveServicePrice + platformFeeAmount;

      servicePriceRow.textContent = formatMoney(basePrice);
      promoDiscountRow.textContent = "–" + formatMoney(promoDiscount);
      effectiveServiceRow.textContent = formatMoney(effectiveServicePrice);
      platformFeeRow.textContent = formatMoney(platformFeeAmount);
      totalAmountEl.textContent = formatMoney(finalChargeToCustomer);
      payBtnText.textContent = "Pay " + formatMoney(finalChargeToCustomer) + " securely";

      payBtn.disabled = finalChargeToCustomer <= 0;
    }

    function applyPromoCode(code) {
      const upper = code.toUpperCase();
      appliedPromo = null;
      promoMessage.style.color = "var(--text-muted)";
      promoMessage.textContent = "";

      if (!upper) {
        promoMessage.textContent = "Enter a promo code if you have one.";
        recomputeTotals();
        return;
      }

      let discount = 0;
      if (upper === "WELCOME50") {
        discount = basePrice * 0.5;
        if (discount > 200) discount = 200;
        appliedPromo = {
          code: upper,
          type: "percent",
          value: 50,
          discountAmount: discount,
        };
        promoMessage.style.color = "var(--text-muted)";
        promoMessage.textContent = "WELCOME50 applied – 50% off service price up to ₹200.";
      } else if (upper === "FLAIR100") {
        discount = 100;
        if (discount > basePrice) discount = basePrice;
        appliedPromo = {
          code: upper,
          type: "flat",
          value: 100,
          discountAmount: discount,
        };
        promoMessage.style.color = "var(--text-muted)";
        promoMessage.textContent = "FLAIR100 applied – ₹100 off service price.";
      } else {
        promoMessage.style.color = "var(--danger)";
        promoMessage.textContent = "Invalid or unsupported promo code.";
      }

      recomputeTotals();
    }

    applyPromoBtn.addEventListener("click", () => {
      applyPromoCode(promoInput.value.trim());
    });

    paymentOptions.forEach((opt) => {
      opt.addEventListener("click", () => {
        paymentOptions.forEach((o) => {
          o.classList.remove("active");
          const rc = o.querySelector(".radio-check");
          rc.classList.remove("checked");
          rc.innerHTML = "";
        });
        opt.classList.add("active");
        const rc = opt.querySelector(".radio-check");
        rc.classList.add("checked");
        rc.innerHTML = '<i class="fas fa-check"></i>';
        currentMethod = opt.dataset.method;

        if (currentMethod === "card") {
          cardFormSheet.classList.add("visible");
        } else {
          cardFormSheet.classList.remove("visible");
        }
      });
    });

    cardNumberInput.addEventListener("input", () => {
      let v = cardNumberInput.value.replace(/\D/g, "").slice(0, 16);
      const groups = v.match(/.{1,4}/g) || [];
      cardNumberInput.value = groups.join(" ");
    });

    cardExpiryInput.addEventListener("input", () => {
      let v = cardExpiryInput.value.replace(/\D/g, "").slice(0, 4);
      if (v.length >= 3) {
        cardExpiryInput.value = v.slice(0, 2) + "/" + v.slice(2);
      } else {
        cardExpiryInput.value = v;
      }
    });

    cardFormCloseBtn.addEventListener("click", () => {
      cardFormSheet.classList.remove("visible");
      cardErrorText.textContent = "";
    });

    function validateCardForm() {
      cardErrorText.textContent = "";
      const num = cardNumberInput.value.replace(/\s/g, "");
      const exp = cardExpiryInput.value.trim();
      const cvv = cardCvvInput.value.trim();
      const name = cardNameInput.value.trim();

      if (num.length < 12) {
        cardErrorText.textContent = "Please enter a valid card number.";
        return false;
      }
      if (!/^\d{2}\/\d{2}$/.test(exp)) {
        cardErrorText.textContent = "Please enter a valid expiry in MM/YY.";
        return false;
      }
      if (cvv.length < 3) {
        cardErrorText.textContent = "Please enter a valid CVV.";
        return false;
      }
      if (!name) {
        cardErrorText.textContent = "Please enter the name on card.";
        return false;
      }
      return true;
    }

    upiCloseBtn.addEventListener("click", () => {
      upiOverlay.style.display = "none";
    });

    upiApps.forEach((app) => {
      app.addEventListener("click", async () => {
        upiOverlay.style.display = "none";
        await createBookingAndConfirm();
      });
    });

    doneBtn.addEventListener("click", () => {
      window.location.href = "index.html";
    });

    payBtn.addEventListener("click", async () => {
      if (currentMethod === "upi") {
        upiOverlay.style.display = "flex";
      } else if (currentMethod === "card") {
        if (!validateCardForm()) return;
        payBtn.disabled = true;
        payBtnText.textContent = "Processing...";
        setTimeout(async () => {
          await createBookingAndConfirm();
          payBtn.disabled = false;
          recomputeTotals();
        }, 800);
      }
    });

    async function createBookingAndConfirm() {
      if (!db || !ownerId || !selectedStartTime || !selectedEndTime) {
        alert("Could not create booking. Missing data.");
        return;
      }

      const promoDiscount = appliedPromo ? appliedPromo.discountAmount : 0;
      const effectiveServicePrice = Math.max(0, basePrice - promoDiscount);
      const platformFeeAmount = effectiveServicePrice * PLATFORM_FEE_PERCENT;
      const finalChargeToCustomer = effectiveServicePrice + platformFeeAmount;

      try {
        const apptsCol = collection(db, "owners", ownerId, "ownerAppointments");
        await addDoc(apptsCol, {
          salonId,
          serviceId,
          serviceName,
          serviceDurationMinutes,
          basePrice,
          promoCode: appliedPromo ? appliedPromo.code : null,
          promoDiscountAmount: promoDiscount,
          effectiveServicePrice,
          platformFeePercent: PLATFORM_FEE_PERCENT,
          platformFeeAmount,
          finalChargeToCustomer,
          salonPayoutAmount: effectiveServicePrice,
          staffId: staffId || null,
          staffName: staffName || null,
          staffRole: staffRole || null,
          dateKey,
          startTime: Timestamp.fromDate(selectedStartTime),
          endTime: Timestamp.fromDate(selectedEndTime),
          kind: "booking",
          status: "upcoming",
          source: "customer_web",
          createdAt: Timestamp.now(),
          updatedAt: Timestamp.now(),
        });

        confirmOverlay.style.display = "flex";
      } catch (e) {
        console.error("Error creating booking:", e);
        alert("Could not confirm booking. Please try again.");
      }
    }

    function addMinutes(date, minutes) {
      return new Date(date.getTime() + minutes * 60000);
    }

    async function loadData() {
      if (!db) {
        alert("Firebase not initialized. Please check firebase-init.js.");
        return;
      }
      if (!salonId || !serviceId || !dateKey || !timeIso) {
        alert("Missing booking details. Please start again.");
        return;
      }

      const salonRef = doc(db, "salons", salonId);
      const salonSnap = await getDoc(salonRef);
      if (salonSnap.exists()) {
        const sData = salonSnap.data() || {};
        salonName = sData.businessName || "Your salon";
        salonNameEl.textContent = salonName;
        ownerId = sData.ownerUid || sData.ownerId || null;
      }

      if (!ownerId) {
        alert("Could not find salon owner. Please try again.");
        return;
      }

      const serviceRef = doc(db, "owners", ownerId, "ownerServices", serviceId);
      const serviceSnap = await getDoc(serviceRef);
      if (!serviceSnap.exists()) {
        alert("Service not found.");
        return;
      }
      const svc = serviceSnap.data() || {};
      serviceName = svc.name || "Service";
      basePrice = Number(svc.price || 0);
      serviceDurationMinutes = Number(svc.durationMinutes || 0) || 60;

      serviceNameEl.textContent = serviceName;
      servicePriceRow.textContent = formatMoney(basePrice);
      durationTextEl.textContent = serviceDurationMinutes + " minutes";

      selectedStartTime = new Date(timeIso);
      selectedEndTime = addMinutes(selectedStartTime, serviceDurationMinutes);
      dateTimeTextEl.textContent = formatDateTimeLabel(selectedStartTime);

      if (staffId) {
        try {
          const staffRef = doc(db, "owners", ownerId, "ownerStaff", staffId);
          const staffSnap = await getDoc(staffRef);
          if (staffSnap.exists()) {
            const st = staffSnap.data() || {};
            staffName = st.name || "Professional";
            staffRole = st.role || "";
            staffNameEl.textContent = staffRole
              ? staffName + " • " + staffRole
              : staffName;
          }
        } catch (e) {
          console.error("Error loading staff:", e);
        }
      }

      recomputeTotals();
    }

    loadData().catch((e) => {
      console.error("Error initializing checkout:", e);
      alert("Could not load checkout details. Please try again.");
    });
  </script>
</body>
</html>
